<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>American Roulette</title>
      <link rel="stylesheet" href="style.css">
   </head>
   <body>
      <!-- Top Navigation Bar -->
      <div class="topbar">
         <a href="blackjack.html" class="nav-item">Blackjack</a>
         <a href="poker.html" class="nav-item">Poker</a>
         <a href="slots.html" class="nav-item">Slots</a>
         <a href="race.html" class="nav-item">Race</a>
         <a href="#" class="nav-item active">Roulette</a>
      </div>
      <div class="page active" id="roulette">
         <div class="balance" id="balanceDisplay">Balance: 0</div>
         <div class="controls">
            <label>Bet Amount:</label>
            <input type="number" id="betAmount" min="1">
            <label>Bet Type:</label>
            <select id="betType">
               <option>Straight Up</option>
               <option>Split</option>
               <option>Street</option>
               <option>Corner</option>
               <option>Line</option>
               <option>Even/Odd</option>
               <option>High/Low</option>
               <option>Color Bet</option>
            </select>
            <label>Numbers/Type :</label>
            <input type="text" id="numbersInput" placeholder="1 , 2 , 3">
            <div class="bet-buttons">
               <button class="color-btn red" onclick="spin('red')">Red</button>
               <button class="color-btn black" onclick="spin('black')">Black</button>
               <button class="color-btn green" onclick="spin('green')">Green</button>
            </div>
            <button id="spinBtn" onclick="spin(null)">SPIN</button>
         </div>
         <canvas id="wheelCanvas" width="400" height="400"></canvas>
         <div id="result" class="result"></div>
      </div>
      <!-- Import the balance API first -->
      <script type="module">
         import {
           initBalance, getBalance, setBalance, subscribe
         } from './balance.js';
         
         const canvas = document.getElementById("wheelCanvas");
         const ctx = canvas.getContext("2d");
         const resultEl = document.getElementById("result");
         const balanceDisplay = document.getElementById("balanceDisplay");
         const betTypeSelect = document.getElementById("betType");
         const numbersInput = document.getElementById("numbersInput");
         const betButtonsContainer = document.querySelector(".bet-buttons");
         const spinBtn = document.getElementById("spinBtn");
         
         // ------------------ WHEEL SETUP ------------------
         const sequence = [
           "0", "28", "9", "26", "30", "11", "7", "20", "32", "17",
           "5", "22", "34", "15", "3", "24", "36", "13", "1", "00",
           "27", "10", "25", "29", "12", "8", "19", "31", "18", "6",
           "21", "33", "16", "4", "23", "35", "14", "2"
         ];
         const reds = new Set(["1","3","5","7","9","12","14","16","18","19","21","23","25","27","30","32","34","36"]);
         const blacks = new Set(["2","4","6","8","10","11","13","15","17","20","22","24","26","28","29","31","33","35"]);
         const slices = sequence.map(num => ({
           color: reds.has(num) ? "red" : blacks.has(num) ? "black" : "green",
           num
         }));
         
         let rotation = 0;
         let spinning = false;
         
         function drawWheel() {
           ctx.clearRect(0, 0, canvas.width, canvas.height);
           const cx = canvas.width / 2;
           const cy = canvas.height / 2;
           const r = 180;
           const anglePer = (2 * Math.PI) / slices.length;
         
           slices.forEach((s, i) => {
             const start = rotation + i * anglePer;
             const end = start + anglePer;
             ctx.beginPath();
             ctx.moveTo(cx, cy);
             ctx.arc(cx, cy, r, start, end);
             ctx.closePath();
             ctx.fillStyle = s.color;
             ctx.fill();
             ctx.strokeStyle = "white";
             ctx.lineWidth = 1;
             ctx.stroke();
         
             const mid = (start + end) / 2;
             const tx = cx + Math.cos(mid) * (r * 0.7);
             const ty = cy + Math.sin(mid) * (r * 0.7);
             ctx.fillStyle = "white";
             ctx.font = "bold 12px Arial";
             ctx.textAlign = "center";
             ctx.textBaseline = "middle";
             ctx.fillText(s.num, tx, ty);
           });
         
           ctx.fillStyle = "yellow";
           ctx.beginPath();
           ctx.moveTo(cx, cy - r - 10);
           ctx.lineTo(cx - 10, cy - r + 20);
           ctx.lineTo(cx + 10, cy - r + 20);
           ctx.closePath();
           ctx.fill();
         }
         
         // ------------------ SPIN LOGIC ------------------
         async function spin(colorGuess = null) {
           if (spinning) return;
         
           const balance = getBalance();
           const bet = parseInt(document.getElementById("betAmount").value);
           const betType = betTypeSelect.value;
           const input = numbersInput.value.trim();
         
           if (isNaN(bet) || bet <= 0 || bet > balance) {
             resultEl.innerText = "❗ Invalid bet amount.";
             return;
           }
         
           spinning = true;
         
           // Random outcome
           const landedIndex = Math.floor(Math.random() * slices.length);
           const landed = slices[landedIndex];
           const landedNum = landed.num;
           const landedColor = landed.color;
         
           // Wheel geometry
           const anglePer = (2 * Math.PI) / slices.length;
         
           // The pointer is drawn at the top (rotation = -Math.PI/2),
           // so we align the center of the winning slice to that.
           const sliceCenterAngle = landedIndex * anglePer + anglePer / 2;
           const targetAngle = -sliceCenterAngle - Math.PI / 2;
         
           const extraSpins = Math.floor(Math.random() * 4) + 8;
           const finalRotation = rotation + (2 * Math.PI * extraSpins) + targetAngle;
         
           const startRotation = rotation;
           const duration = 4500;
           const startTime = performance.now();
         
           function animate(time) {
             const elapsed = time - startTime;
             const progress = Math.min(elapsed / duration, 1);
             const eased = 1 - Math.pow(1 - progress, 3); // ease-out cubic
             rotation = startRotation + (finalRotation - startRotation) * eased;
             drawWheel();
             if (progress < 1) {
               requestAnimationFrame(animate);
             } else {
               spinning = false;
               rotation = finalRotation % (2 * Math.PI);
               drawWheel(); // final precise draw
               resolveBet(betType, input, colorGuess, bet, landedColor, landedNum);
             }
           }
         
           requestAnimationFrame(animate);
         }
         
         
         // ------------------ BET RESOLUTION ------------------
         async function resolveBet(type, input, colorGuess, bet, landedColor, landedNum) {
           let balance = getBalance();
           let win = false, payout = 0;
           const nums = input.split(",").map(n => n.trim()).filter(n => n);
         
           if (type === "Color Bet" && colorGuess) {
             if (colorGuess === landedColor) {
               payout = (colorGuess === "green") ? 14 : 2;
               win = true;
             }
           } else if (["Straight Up","Split","Street","Corner","Line"].includes(type) && nums.includes(landedNum)) {
             payout = { "Straight Up": 35, "Split": 17, "Street": 11, "Corner": 8, "Line": 5 }[type];
             win = true;
           } else if (type === "Even/Odd" && !["0","00"].includes(landedNum)) {
             if ((input.toLowerCase() === "even" && parseInt(landedNum) % 2 === 0) ||
                 (input.toLowerCase() === "odd" && parseInt(landedNum) % 2 === 1)) {
               payout = 1; win = true;
             }
           } else if (type === "High/Low" && !["0","00"].includes(landedNum)) {
             if ((input.toLowerCase() === "high" && parseInt(landedNum) >= 19) ||
                 (input.toLowerCase() === "low" && parseInt(landedNum) <= 18)) {
               payout = 1; win = true;
             }
           }
         
           if (win) {
             const winnings = bet * payout;
             await setBalance(balance + winnings);
             resultEl.innerText = `✅ You WON! Landed on ${landedColor.toUpperCase()} ${landedNum}\n+${winnings}`;
           } else {
             await setBalance(balance - bet);
             resultEl.innerText = `❌ You lost. Landed on ${landedColor.toUpperCase()} ${landedNum}\n-${bet}`;
           }
           drawWheel();
         }
         
         // ------------------ DYNAMIC BET BUTTONS ------------------
         function updateBetButtons() {
           const type = betTypeSelect.value;
           betButtonsContainer.innerHTML = "";
         
           if (type === "Color Bet") {
             const redBtn = document.createElement("button");
             redBtn.className = "bet-btn red";
             redBtn.textContent = "Red";
             redBtn.addEventListener("click", () => spin("red"));
         
             const blackBtn = document.createElement("button");
             blackBtn.className = "bet-btn black";
             blackBtn.textContent = "Black";
             blackBtn.addEventListener("click", () => spin("black"));
         
             const greenBtn = document.createElement("button");
             greenBtn.className = "bet-btn green";
             greenBtn.textContent = "Green";
             greenBtn.addEventListener("click", () => spin("green"));
         
             betButtonsContainer.append(redBtn, blackBtn, greenBtn);
           } else if (type === "Even/Odd") {
             const evenBtn = document.createElement("button");
             evenBtn.className = "bet-btn";
             evenBtn.textContent = "Even";
             evenBtn.addEventListener("click", () => numbersInput.value = "even");
         
             const oddBtn = document.createElement("button");
             oddBtn.className = "bet-btn";
             oddBtn.textContent = "Odd";
             oddBtn.addEventListener("click", () => numbersInput.value = "odd");
         
             betButtonsContainer.append(evenBtn, oddBtn);
           } else if (type === "High/Low") {
             const lowBtn = document.createElement("button");
             lowBtn.className = "bet-btn";
             lowBtn.textContent = "Low (1–18)";
             lowBtn.addEventListener("click", () => numbersInput.value = "low");
         
             const highBtn = document.createElement("button");
             highBtn.className = "bet-btn";
             highBtn.textContent = "High (19–36)";
             highBtn.addEventListener("click", () => numbersInput.value = "high");
         
             betButtonsContainer.append(lowBtn, highBtn);
           } else {
             const hint = document.createElement("div");
             hint.className = "bet-hint";
             hint.textContent = "Enter numbers manually (e.g. 1,2,3)";
             betButtonsContainer.appendChild(hint);
           }
         }
         
         // ------------------ INIT ------------------
         async function main() {
           const startingBalance = await initBalance({ defaultBalance: 100, autoRegen: true });
           balanceDisplay.innerText = `Balance: ${startingBalance}`;
           subscribe(bal => { balanceDisplay.innerText = `Balance: ${bal}`; });
           updateBetButtons();
           drawWheel();
         }
         
         // Event listeners
         betTypeSelect.addEventListener("change", updateBetButtons);
         spinBtn.addEventListener("click", () => spin(null));
         
         main();
      </script>
   </body>
</html>
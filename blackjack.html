<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Blackjack</title>
      <link rel="stylesheet" href="style.css">
      <link rel="stylesheet" href="cards.css">
   </head>
   <body>
      <!-- Top Navigation Bar -->
      <div class="topbar">
         <a href="#" class="nav-item active" onclick="switchPage('blackjack')">Blackjack</a>
         <a href="poker.html" class="nav-item">Poker</a>
         <a href="slots.html" class="nav-item">Slots</a>
         <a href="race.html" class="nav-item">Race</a>
         <a href="index.html" class="nav-item">Roulette</a>
         <a href="acerace.html" class="nav-item">AceRace</a>
      </div>
      <!-- Blackjack Page -->
      <div id="blackjack" class="page active">
         <div class="balance" id="balanceDisplay">Balance: ...</div>
         <div class="controls">
            <label>Bet:</label>
            <input type="number" id="betInput" min="1">
            <button id="dealBtn">Deal</button>
            <button id="hitBtn" disabled>Hit</button>
            <button id="standBtn" disabled>Stand</button>
         </div>
         <div class="game-area">
            <div class="hand">
               <h3>Dealer</h3>
               <div id="dealerCards" class="cards"></div>
               <div id="dealerTotal" class="total"></div>
            </div>
            <div class="hand">
               <h3>You</h3>
               <div id="playerCards" class="cards"></div>
               <div id="playerTotal" class="total"></div>
            </div>
         </div>
         <div id="result" class="result"></div>
      </div>
      <!-- Load balance module and main game script -->
      <script type="module">
         import { 
           initBalance, getBalance, setBalance, subscribe 
         } from './balance.js';
         
         // ----------- BALANCE INITIALIZATION -----------
         const balanceDisplay = document.getElementById("balanceDisplay");
         const updateDisplay = bal => { balanceDisplay.textContent = "Balance: " + bal; };
         
         let balance = await initBalance({ defaultBalance: 100, autoRegen: true });
         subscribe(updateDisplay);
         updateDisplay(balance);
         
         // ----------- PAGE HANDLING -----------
         function switchPage(id) {
           document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
           document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
           document.getElementById(id).classList.add('active');
           event.target.classList.add('active');
         }
         
         // ----------- BLACKJACK LOGIC -----------
         const suits = ["‚ô†", "‚ô•", "‚ô¶", "‚ô£"];
         const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
         let deck = [];
         let playerHand = [];
         let dealerHand = [];
         let bet = 0;
         let gameOver = false;
         
         const dealerCards = document.getElementById("dealerCards");
         const playerCards = document.getElementById("playerCards");
         const dealerTotal = document.getElementById("dealerTotal");
         const playerTotal = document.getElementById("playerTotal");
         const resultText = document.getElementById("result");
         
         const dealBtn = document.getElementById("dealBtn");
         const hitBtn = document.getElementById("hitBtn");
         const standBtn = document.getElementById("standBtn");
         
         // --- Deck setup ---
         function createDeck() {
           deck = [];
           for (let s of suits) for (let v of values) deck.push({ suit: s, value: v });
           deck.sort(() => Math.random() - 0.5);
         }
         
         function cardValue(card) {
           if (["J", "Q", "K"].includes(card.value)) return 10;
           if (card.value === "A") return 11;
           return parseInt(card.value);
         }
         
         function handValue(hand) {
           let total = 0, aces = 0;
           for (let c of hand) {
             total += cardValue(c);
             if (c.value === "A") aces++;
           }
           while (total > 21 && aces > 0) { total -= 10; aces--; }
           return total;
         }
         
         function drawCard(hand) {
           const card = deck.pop();
           hand.push(card);
           return card;
         }
         
         function createCardHTML(card) {
           const red = (card.suit === "‚ô•" || card.suit === "‚ô¶");
           return `
             <div class="card ${red ? 'red' : 'black'} animate-card">
               <div class="corner top">${card.value}<br>${card.suit}</div>
               <div class="center">${card.suit}</div>
               <div class="corner bottom">${card.value}<br>${card.suit}</div>
             </div>`;
         }
         
         function renderHands(hideDealer = true) {
           dealerCards.innerHTML = dealerHand.map((c, i) => {
             if (hideDealer && i === 0 && !gameOver) return `<div class='card back'></div>`;
             return createCardHTML(c);
           }).join("");
         
           playerCards.innerHTML = playerHand.map(createCardHTML).join("");
           dealerTotal.innerText = hideDealer && !gameOver ? "Dealer: ?" : "Dealer: " + handValue(dealerHand);
           playerTotal.innerText = "You: " + handValue(playerHand);
         }
         
         // --- Gameplay logic ---
         async function startGame() {
           bet = parseInt(document.getElementById("betInput").value);
           balance = getBalance();
         
           if (isNaN(bet) || bet <= 0 || bet > balance) {
             resultText.innerText = "‚ùó Invalid bet amount.";
             return;
           }
         
           await setBalance(balance - bet);
           gameOver = false;
           createDeck();
           playerHand = [];
           dealerHand = [];
         
           drawCard(playerHand);
           drawCard(dealerHand);
           drawCard(playerHand);
           drawCard(dealerHand);
         
           hitBtn.disabled = false;
           standBtn.disabled = false;
           dealBtn.disabled = true;
           resultText.innerText = "";
         
           renderHands();
         }
         
         function hit() {
           drawCard(playerHand);
           renderHands();
           if (handValue(playerHand) > 21) {
             resultText.innerText = `üíÄ Bust! You lose ${bet}`;
             endGame(false);
           }
         }
         
         async function stand() {
           hitBtn.disabled = true;
           standBtn.disabled = true;
         
           while (handValue(dealerHand) < 17) drawCard(dealerHand);
         
           const playerVal = handValue(playerHand);
           const dealerVal = handValue(dealerHand);
           renderHands(false);
         
           if (dealerVal > 21 || playerVal > dealerVal) {
             resultText.innerText = `üèÜ You win! +${bet * 2}`;
             await setBalance(getBalance() + bet * 2);
           } else if (dealerVal === playerVal) {
             resultText.innerText = "ü§ù It's a tie! Bet returned.";
             await setBalance(getBalance() + bet);
           } else {
             resultText.innerText = `‚ùå Dealer wins. You lose ${bet}`;
           }
         
           endGame(true);
         }
         
         function endGame(showDealer = true) {
           gameOver = true;
           renderHands(!showDealer);
           hitBtn.disabled = true;
           standBtn.disabled = true;
           dealBtn.disabled = false;
         }
         
         // Attach button handlers
         dealBtn.addEventListener("click", startGame);
         hitBtn.addEventListener("click", hit);
         standBtn.addEventListener("click", stand);
      </script>
   </body>
</html>
<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Race Betting Game</title>
      <link rel="stylesheet" href="style.css">
   </head>
   <body>
      <!-- Top Navigation Bar -->
      <div class="topbar">
         <a href="blackjack.html" class="nav-item">Blackjack</a>
         <a href="poker.html" class="nav-item">Poker</a>
         <a href="slots.html" class="nav-item">Slots</a>
         <a href="race.html" class="nav-item active">Race</a>
         <a href="index.html" class="nav-item">Roulette</a>
         <a href="acerace.html" class="nav-item">AceRace</a>
      </div>
      <!-- Race Page -->
      <div id="race" class="page active">
         <div class="balance" id="balanceDisplay">Balance: 0</div>
         <div class="controls">
            <label>Horse (1‚Äì18):</label>
            <input type="number" id="horseInput" min="1" max="18">
            <label>Bet:</label>
            <input type="number" id="betInput" min="1">
            <button id="startBtn">Start Race</button>
         </div>
         <canvas id="raceCanvas" width="740" height="480"></canvas>
         <div id="result" class="result"></div>
      </div>
      <!-- Stats Page -->
      <div id="stats" class="page">
         <h2>Game Statistics</h2>
         <p id="statsText">No races run yet.</p>
      </div>
      <!-- Import the balance system -->
      <script type="module">
         import {
             initBalance,
             getBalance,
             setBalance,
             saveBalance,
             subscribe
         } from "./balance.js";
         
         const canvas = document.getElementById("raceCanvas");
         const ctx = canvas.getContext("2d");
         const horses = Array.from({ length: 18 }, (_, i) => i + 1);
         const result = document.getElementById("result");
         const startBtn = document.getElementById("startBtn");
         const balanceDisplay = document.getElementById("balanceDisplay");
         
         let racing = false;
         let raceData = {};
         let stats = { races: 0, wins: 0, losses: 0 };
         
         // --- PAGE INITIALIZATION ---
         (async () => {
             await initBalance({ defaultBalance: 100, autoRegen: true });
             subscribe(bal => balanceDisplay.innerText = "Balance: " + bal);
         })();
         
         // --- DRAWING FUNCTION ---
         function drawRace() {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
             const finishLine = canvas.width - 40;
             horses.forEach((num, i) => {
                 const y = 20 + i * 25;
                 const x = raceData.positions[i];
                 const color = num === raceData.choice ? "gold" : "black";
                 ctx.fillStyle = color;
                 ctx.fillRect(10 + x, y, 10, 10);
                 ctx.fillStyle = "black";
                 ctx.fillText(num, 0, y + 10);
                 ctx.fillText("üèÅ", finishLine + 10, y + 10);
             });
         }
         
         // --- RACE START ---
         startBtn.addEventListener("click", startRace);
         
         async function startRace() {
             if (racing) return;
         
             const horseChoice = parseInt(document.getElementById("horseInput").value);
             const bet = parseInt(document.getElementById("betInput").value);
             const balance = getBalance();
         
             if (isNaN(horseChoice) || horseChoice < 1 || horseChoice > 18) {
                 result.innerText = "‚ùó Invalid horse number.";
                 return;
             }
             if (isNaN(bet) || bet <= 0 || bet > balance) {
                 result.innerText = "‚ùó Invalid bet amount.";
                 return;
             }
         
             raceData = {
                 bet,
                 choice: horseChoice,
                 positions: new Array(18).fill(0),
                 finished: false,
                 winner: null
             };
         
             racing = true;
             result.innerText = "üèÅ The race has begun!";
             runRace();
         }
         
         function runRace() {
             const finishLine = canvas.width - 40;
             drawRace();
         
             if (!raceData.finished) {
                 horses.forEach((_, i) => {
                     raceData.positions[i] += Math.floor(Math.random() * 8) + 1;
                     if (raceData.positions[i] >= finishLine && !raceData.finished) {
                         raceData.finished = true;
                         raceData.winner = i + 1;
                     }
                 });
         
                 if (!raceData.finished) {
                     requestAnimationFrame(runRace);
                 } else {
                     endRace();
                 }
             }
         }
         
         async function endRace() {
             racing = false;
             const { winner, bet, choice } = raceData;
             let balance = getBalance();
         
             stats.races++;
             if (winner === choice) {
                 const winnings = bet * 3;
                 balance += winnings;
                 await setBalance(balance);
                 stats.wins++;
                 result.innerText = `üèÜ Horse ${winner} WON! You picked correctly! +${winnings}`;
             } else {
                 balance -= bet;
                 await setBalance(balance);
                 stats.losses++;
                 result.innerText = `‚ùå Horse ${winner} won the race. You lost ${bet}.`;
             }
         
             document.getElementById("statsText").innerText =
                 `Races: ${stats.races} | Wins: ${stats.wins} | Losses: ${stats.losses}`;
         }
      </script>
   </body>
</html>